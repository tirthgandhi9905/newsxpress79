-- Required extensions

create extension if not exists "pgcrypto";

-- 0. Helper: updated_at trigger

create or replace function trigger_set_timestamp()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

-- 1. Profiles

create table if not exists profiles (
  id uuid primary key default gen_random_uuid(),
  auth_id uuid references auth.users(id) on delete cascade, 
  full_name text,
  username text unique,
  email text unique not null,
  avatar_url text,

   fcm_token text,                    
    categories text[],   

  -- NEW PASSWORD FIELDS
  password text,                     -- hashed password
  pass_updated_times timestamptz[],  -- array of times when password changed
  
  -- NEW PREFERENCE FIELDS
  actor text[],
  place text,
  topic text,

  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create index if not exists idx_profiles_auth_id on profiles(auth_id);

-- Trigger to update updated_at
create trigger trg_profiles_updated_at
  before update on profiles
  for each row execute function trigger_set_timestamp();

-- Trigger to record password change timestamps
create or replace function trigger_record_password_change()
returns trigger language plpgsql as $$
begin
  if (new.password is distinct from old.password) then
    new.pass_updated_times := coalesce(old.pass_updated_times, '{}') || now();
  end if;
  return new;
end;
$$;

create trigger trg_profiles_password_change
before update on profiles
for each row
execute function trigger_record_password_change();

-- 2. Sources

create table if not exists sources (
  id uuid primary key default gen_random_uuid(),
  name text not null unique,
  website_url text,
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create trigger trg_sources_updated_at
  before update on sources
  for each row execute function trigger_set_timestamp();

-- 3. Articles

create table if not exists articles (
  id uuid primary key default gen_random_uuid(),
  title text not null,
  summary text,
  original_url text not null,
  source_id uuid references sources(id) on delete set null,
  published_at timestamptz not null,
  content_text text,
  language_code varchar(5),
  image_url text,
  actors text[],          
  place text,             
  topic text,                      
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create unique index if not exists uq_articles_original_url on articles(original_url);

create trigger trg_articles_updated_at
  before update on articles
  for each row execute function trigger_set_timestamp();

-- 4. User Interactions

create table if not exists user_interactions (
  id uuid primary key default gen_random_uuid(),
  profile_id uuid references profiles(id) on delete cascade,
  article_id uuid references articles(id) on delete cascade,
  interaction_at timestamptz default now(),
  bookmark_timestamp timestamptz,
  note text
);

create index if not exists idx_user_interactions_profile on user_interactions(profile_id);
create index if not exists idx_user_interactions_article on user_interactions(article_id);

-- 5. Notifications

create table if not exists notifications (
  id uuid primary key default gen_random_uuid(),
  profile_id uuid references profiles(id) on delete cascade,
  title text,
  message text not null,
  status text default 'sent',
  sent_at timestamptz default now(),
  delivered_at timestamptz,
  read_at timestamptz
);

create index if not exists idx_notifications_profile on notifications(profile_id);

-- 6. Useful Views

create or replace view vw_articles_with_source as
select 
  a.id, 
  a.title, 
  a.summary, 
  a.original_url, 
  a.source_id, 
  s.name as source_name, 
  a.published_at, 
  a.created_at,
  a.actors,
  a.place,
  a.topic
from articles a 
left join sources s on a.source_id = s.id;

-- 7. Final sanity indexes

create index if not exists idx_articles_published_at on articles(published_at);
create index if not exists idx_articles_source_id on articles(source_id);
create index if not exists idx_profiles_username on profiles(username);

-- 